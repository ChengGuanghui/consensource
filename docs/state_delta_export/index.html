<!DOCTYPE HTML>
<html lang="en" class="sidebar-visible no-js">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>State Delta Export - Blockchain at Target Docs</title>
        <meta content="text/html; charset=utf-8" http-equiv="Content-Type">
        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff" />

        <link rel="shortcut icon" href="https:&#x2F;&#x2F;pages.github.com&#x2F;target&#x2F;ConsenSource&#x2F;favicon.png">
        
        
        <link rel="stylesheet" href="https:&#x2F;&#x2F;pages.github.com&#x2F;target&#x2F;ConsenSource&#x2F;variables.css">
        <link rel="stylesheet" href="https:&#x2F;&#x2F;pages.github.com&#x2F;target&#x2F;ConsenSource&#x2F;general.css">
        <link rel="stylesheet" href="https:&#x2F;&#x2F;pages.github.com&#x2F;target&#x2F;ConsenSource&#x2F;chrome.css">
        <link rel="stylesheet" href="https:&#x2F;&#x2F;pages.github.com&#x2F;target&#x2F;ConsenSource&#x2F;print.css" media="print">
        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" href="https:&#x2F;&#x2F;pages.github.com&#x2F;target&#x2F;ConsenSource&#x2F;highlight.css">
        <link rel="stylesheet" href="https:&#x2F;&#x2F;pages.github.com&#x2F;target&#x2F;ConsenSource&#x2F;tomorrow-night.css">
        <link rel="stylesheet" href="https:&#x2F;&#x2F;pages.github.com&#x2F;target&#x2F;ConsenSource&#x2F;ayu-highlight.css">
        

        <!-- Fonts -->
        <link rel="stylesheet" href="https:&#x2F;&#x2F;pages.github.com&#x2F;target&#x2F;ConsenSource&#x2F;FontAwesome&#x2F;css&#x2F;font-awesome.min.css">
        <link href="https://fonts.googleapis.com/css?family=Open+Sans:300italic,400italic,600italic,700italic,800italic,400,300,600,700,800" rel="stylesheet" type="text/css">
        <link href="https://fonts.googleapis.com/css?family=Source+Code+Pro:500" rel="stylesheet" type="text/css">

        
        

        
        
    </head>
    <body class="light">
        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script type="text/javascript">
            try {
                var theme = localStorage.getItem('mdbook-theme');
                var sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script type="text/javascript">
            var theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { } 
            if (theme === null || theme === undefined) { theme = 'light'; }
            document.body.className = theme;
            document.querySelector('html').className = theme + ' js';
        </script>

        <!-- Hide / unhide sidebar before it is displayed -->
        <script type="text/javascript">
            var html = document.querySelector('html');
            var sidebar = 'hidden';
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            }
            html.classList.remove('sidebar-visible');
            html.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            
            
            <nav role="navigation">
                <ul>
                    
                        
                        
                            <li >
                                
                                <strong><a href="https:&#x2F;&#x2F;pages.github.com&#x2F;target&#x2F;ConsenSource&#x2F;about&#x2F;" class="subsection-title">
                                    
                                    Consensource
                                </a></strong>
                                
                            </li>
                        
                            <li class="active">
                                
                                <strong><a href="https:&#x2F;&#x2F;pages.github.com&#x2F;target&#x2F;ConsenSource&#x2F;state_delta_export&#x2F;" class="subsection-title">
                                    
                                    State Delta Export
                                </a></strong>
                                
                            </li>
                        
                            <li >
                                
                                <strong><a href="https:&#x2F;&#x2F;pages.github.com&#x2F;target&#x2F;ConsenSource&#x2F;cert_registry_transaction_family&#x2F;" class="subsection-title">
                                    
                                    Transaction Family
                                </a></strong>
                                
                            </li>
                        
                            <li >
                                
                                <strong><a href="https:&#x2F;&#x2F;pages.github.com&#x2F;target&#x2F;ConsenSource&#x2F;glossary&#x2F;" class="subsection-title">
                                    
                                    Glossary
                                </a></strong>
                                
                            </li>
                        
                    
                </ul>
            </nav>
            
            
        </nav>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                <div id="menu-bar" class="menu-bar">
                    <div id="menu-bar-sticky-container">
                        <div class="left-buttons">
                            <button id="sidebar-toggle" class="icon-button" type="button" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                                <i class="fa fa-bars"></i>
                            </button>
                            <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                                <i class="fa fa-paint-brush"></i>
                            </button>
                            <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                                <li role="none"><button role="menuitem" class="theme" id="light">Light <span class="default">(default)</span></button></li>
                                <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                                <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                                <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                                <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                            </ul>
                            <button id="search-toggle" class="icon-button" type="button" title="Search. (Shortkey: s)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="S" aria-controls="searchbar">
                                <i class="fa fa-search"></i>
                            </button>
                        </div>

                        <h1 class="menu-title">Blockchain at Target Docs</h1> 
                    </div>
                </div>

                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <input type="search" name="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>

                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script type="text/javascript">
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        
    <h1>State Delta Export</h1>
    <h1 id="overview">Overview</h1>
<p>The goal of State Delta Export is to provide a mechanism for exporting on-chain state values from a validator to an external data store. This allows applications to efficiently query their state values. The state delta export implements an event subscription client that subscribes to block commit events and Sawtooth state delta at specific addresses (in this case we will subscribe to all state delta events at the Certificate Registry namespace). Sawtooth sends these events whenever the validatorâ€™s state is updated. The events contain the raw state data at the updated addresses. The event subscription client processes the event data and uses it to update the reporting database, an off-chain copy of blockchain state. The REST API can query this database when a client needs to get information from the blockchain.</p>
<p>This off-chain state access comes at the expense of relying on a single validator for state updates, this puts the application at risk of having stale data or forked state if the validator supplying the state updates comes out of consensus or is disconnected from the network. Below are guidelines on how to structure the reporting DB so fork resolution is easy.</p>
<h1 id="reporting-database-structure">Reporting Database Structure</h1>
<p><img src="https://github.com/target/ConsenSource/blob/master/docs_content/content/state_delta_export/CertRegistry_DBSchema.png?raw=true" alt="DB Schema" /></p>
<p>The reporting DB has three types of tables: sawtooth-core tables (Blocks), domain-specific state tables (Agents, Organizations, Authorizations, Certificates, CertificateData), and application tables (tables supporting off-chain application components, such as Auth, in the schema above).
The reporting DB should follow the <a href="https://en.wikipedia.org/wiki/Slowly_changing_dimension#Type_2:_add_new_row">Type 2 of Slowly Changing Dimensions</a> data management pattern, so that fork resolution is easy.</p>
<p>For use in a State Delta Export, a state table includes additional columns of start_block_num and end_block_num. The â€‹start_block_numâ€‹ and â€‹end_block_numâ€‹ columns specify the block range in which that state value is set or exists. Values that are valid as of the current block have â€‹end_block_numâ€‹ set to MAX_UINT_64.</p>
<p>Because there might be state objects in the database that refer to the same object in state at different block heights (with different block numbers), the primary key for each object cannot be the same as the objectâ€™s natural key in blockchain state. Instead, use a sequence ID column or another unique ID scheme as the primary key. For better query performance, we recommend creating indexes on the natural key of the entry and the end_block_num.</p>
<h1 id="fork-resolution">Fork resolution</h1>
<p>The following pseudocode demonstrates the fork resolution process:</p>
<pre style="background-color:#2b303b">
<span style="background-color:#2b303b;color:#c0c5ce;">resolve_fork(existing_block):
</span><span style="background-color:#2b303b;color:#c0c5ce;">  </span><span style="background-color:#2b303b;color:#c0c5ce;">for table in domain_tables:						
</span><span style="background-color:#2b303b;color:#c0c5ce;">    </span><span style="background-color:#2b303b;color:#c0c5ce;">delete from table where start_block_num &gt;= existing_block.block_num
</span><span style="background-color:#2b303b;color:#c0c5ce;">    </span><span style="background-color:#2b303b;color:#c0c5ce;">update table set end_block_num = MAX_UINT_64 \					
</span><span style="background-color:#2b303b;color:#c0c5ce;">      </span><span style="background-color:#2b303b;color:#c0c5ce;">where end_block_num &gt;= existing_block.block_num
</span><span style="background-color:#2b303b;color:#c0c5ce;">  </span><span style="background-color:#2b303b;color:#c0c5ce;">delete from block where block_num &gt;= existing_block.block_num
</span></pre>

                    </main>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                
    
    
    
    
        
            
        
    
        
            
        
    
        
            
        
    
        
            
                
                    <a class="previous" href="https:&#x2F;&#x2F;pages.github.com&#x2F;target&#x2F;ConsenSource&#x2F;about&#x2F;"><i class="fa fa-angle-left"></i></a>
                
                
                
            
        
    


                
    
        
        
        
        
            
            
        
            
            
                
            
        
            
                <a class="next" href="https:&#x2F;&#x2F;pages.github.com&#x2F;target&#x2F;ConsenSource&#x2F;cert_registry_transaction_family&#x2F;"><i class="fa fa-angle-right"></i></a>
                
                
            
            
        
            
            
        
    

            </nav>

        </div>

        
        <script src="https:&#x2F;&#x2F;pages.github.com&#x2F;target&#x2F;ConsenSource&#x2F;elasticlunr.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="https:&#x2F;&#x2F;pages.github.com&#x2F;target&#x2F;ConsenSource&#x2F;search_index.en.js"  type="text/javascript" charset="utf-8"></script>
        <script src="https:&#x2F;&#x2F;pages.github.com&#x2F;target&#x2F;ConsenSource&#x2F;mark.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="https:&#x2F;&#x2F;pages.github.com&#x2F;target&#x2F;ConsenSource&#x2F;searcher.js" type="text/javascript" charset="utf-8"></script>
        <script src="https:&#x2F;&#x2F;pages.github.com&#x2F;target&#x2F;ConsenSource&#x2F;clipboard.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="https:&#x2F;&#x2F;pages.github.com&#x2F;target&#x2F;ConsenSource&#x2F;highlight.js" type="text/javascript" charset="utf-8"></script>
        <script src="https:&#x2F;&#x2F;pages.github.com&#x2F;target&#x2F;ConsenSource&#x2F;book.js" type="text/javascript" charset="utf-8"></script>
        
    </body>
</html>
